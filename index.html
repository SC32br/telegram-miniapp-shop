<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мой магазин в Telegram</title>
  <style>
    body {
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 0;
      background:
        linear-gradient(120deg, rgba(220,245,255,0.7), rgba(130,170,220,0.62)),
        url('https://web.tk646.ru/wp-content/uploads/2025/07/gftg0wdufx1r0_9xrxonq_d28ae17e662d4e358d5b34cfa7411caf.jpg') center/cover no-repeat;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #cartButton {
      position: fixed; top: 24px; right: 24px; z-index: 1000;
      display:flex;align-items:center;justify-content:center;width:54px;height:54px;
      background:linear-gradient(135deg,#2b95ff 25%,#7bd4fa 100%);
      border:none; border-radius:50%;
      box-shadow:0 6px 16px #1d96e88f;
      cursor:pointer; padding:0;
      transition:box-shadow 0.16s,background 0.18s;
    }
    #cartButton svg {margin:0;}
    #cartCount {
      font-size:14px;min-width:22px;height:22px;line-height:22px;
      background:#fb3660;color:#fff;
      position:absolute;top:2px;right:2px;
      border-radius:50%;padding:0 3px;
      text-align:center;display:none;font-weight:bold;
      box-shadow:0 2px 6px #d20b2d42;
    }
    #cartModal { display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(33,40,60,0.25);backdrop-filter:blur(2px);align-items:center;justify-content:center;}
    #cartModal.active { display: flex; }
    #cartModalContent {
      background: #f9fcff; border-radius: 22px;
      max-width: 370px; width: 98%; min-height:150px;
      padding: 36px 20px 23px 20px;
      box-shadow: 0 12px 46px #1681b366;
      position: relative; text-align: center;
      animation: modalAppear 0.18s;
    }
    @keyframes modalAppear { from{transform:translateY(-17px) scale(0.98)} to{transform:none;} }
    #cartModalClose {position:absolute;top:7px;right:11px;background:none;border:none;font-size:30px;color:#d1607f;font-weight:800;cursor:pointer;z-index:2;transition:color 0.17s;}
    #cartModalClose:hover { color: #ff2f57;}
    .cart-items-list {list-style:none;padding:0;margin:0 0 18px 0;text-align:left;max-height:190px;overflow-y:auto;}
    .cart-item {display:flex;align-items:center;justify-content:space-between;font-size:16px;padding:5px 0 8px 0;border-bottom:1px solid #e6f2fa;}
    .cart-item:last-child { border-bottom: none;}
    .cart-actions {margin:26px -8px 0 -8px;display:flex;flex-direction:row;gap:9px;justify-content:space-between;}
    .cart-actions .cartBtn {flex:1;display:flex;align-items:center;justify-content:center;gap:7px;font-size:1em;padding:12px 0;border-radius:17px;border:2px solid transparent;font-weight:800;cursor:pointer;box-shadow:0 2px 8px #1e92e933;transition:all 0.15s;background:#f2faff;color:#269be2;}
    #cartContinueBtn {border-color: #50bafc; background: #f2faff; color: #269be2;}
    #cartContinueBtn:hover {background:#e7f5fc;color:#0077b6;border-color:#31a8dd;}
    #cartContinueBtn svg { margin-right:4px;}
    #cartOrderBtn {background:linear-gradient(90deg,#219b37 0%,#26e29a 100%);color:#fff;border:none;box-shadow:0 2px 8px #22e19733;letter-spacing:0.01em;}
    #cartOrderBtn:hover {background:linear-gradient(90deg,#1e732b 0%,#20d099 100%);}
    .cart-empty {font-size:16px;color:#abacc3;margin-top:17px;}
    .cartTotal {font-size:19px;font-weight:700;color:#188031;margin:16px 0 0 0;text-align:right;display:none;}
    /* --- Модалка заказа --- */
    #orderModal {display:none;position:fixed;z-index:2100;left:0;top:0;width:100vw;height:100vh;background:rgba(33,40,60,0.21);backdrop-filter:blur(2px);align-items:center;justify-content:center;}
    #orderModal.active { display: flex;}
    #orderForm {background:#fff;border-radius:19px;max-width:340px;width:96%;padding:34px 20px 23px 20px;box-shadow:0 6px 40px #1b233866;text-align:center;position:relative;}
    #orderModalClose {position:absolute;top:6px;right:10px;background:none;border:none;font-size:28px;color:#dd2856;font-weight:700;cursor:pointer;z-index:2;}
    #orderModalClose:hover {color:#ff3b4b;}
    #orderForm input {width:100%;margin-bottom:13px;padding:11px;font-size:1em;border-radius:10px;border:1.5px solid #d0e6f6;box-sizing:border-box;outline:none;}
    #orderPhone {border-color:#7be2ff;}
    #phoneHint {font-size:0.98em;color:#539eca;margin:-9px 0 10px 0;text-align:left;}
    #orderError {color:#e02437;font-size:0.99em;margin-top:8px;display:none;}
    @media (max-width:540px) {
      #cartModalContent,#orderForm { max-width:98vw;}
      #cartButton { top:8px; right:8px;width:40px;height:40px;}
    }
    h2#helloTitle {text-align:center;margin:32px 0 0 0;font-size:2rem;font-weight:800;line-height:1.25;letter-spacing:0.01em;color:#134b6b;white-space:pre-line;background:linear-gradient(90deg,#2193b0 0%,#2bc0e4 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    #shopLogo {width:165px;height:auto;position:absolute;top:24px;left:24px;margin:0;border-radius:0;background:transparent;box-shadow:none;z-index:10;display:block;transition:opacity 0.3s;}
    body.inner-page #shopLogo { opacity: 0; pointer-events: none;}
    #mainSection,#loggerSection,#loggerDetailSection,#loggerPricesSection {flex-direction:column;justify-content:center;align-items:center;width:100%;display:flex;}
    .orderBtn {padding:14px 32px;font-size:18px;font-family:inherit;font-weight:800;color:#fff;background:linear-gradient(90deg,#2193b0 0%,#6dd5ed 100%);border:none;border-radius:8px;box-shadow:0 2px 8px rgba(33,147,176,0.15);cursor:pointer;transition:background 0.3s,transform 0.2s,box-shadow 0.2s;margin-top:28px;display:block;width:280px;margin-left:auto;margin-right:auto;letter-spacing:0.01em;}
    .orderBtn:hover {background:linear-gradient(90deg,#43cea2 0%,#185a9d 100%);transform:translateY(-2px) scale(1.02);box-shadow:0 4px 16px rgba(33,147,176,0.22);}
    .backBtn {display:inline-flex;align-items:center;padding:10px 24px;font-size:17px;font-family:inherit;font-weight:800;background:transparent;color:#3885da;border:2px solid #b7deff;border-radius:22px;box-shadow:none;cursor:pointer;margin:22px auto 0 auto;transition:background 0.16s,color 0.16s,border 0.16s,box-shadow 0.16s;gap:10px;}
    .backBtn:hover {background:#e0f3fd;color:#1a5da2;border-color:#a1c8e6;box-shadow:0 2px 8px #bbe7ff45;}
    .card-block {background:rgba(255,255,255,0.7);padding:16px 14px 8px 14px;border-radius:8px;max-width:380px;margin:0 auto 16px;box-sizing:border-box;clear:both;}
    .card-img {width:170px;height:auto;margin:14px 0 10px 0;box-shadow:0 2px 8px #b6c2d5a0;border-radius:8px;background:transparent;display:block;}
    ul {margin:0 0 8px 0;padding-left:22px;text-align:left;font-size:15px;}
  </style>
</head>
<body>
  <!-- КНОПКА КОРЗИНЫ -->
  <button id="cartButton" title="Корзина">
    <svg width="28" height="28" viewBox="0 0 20 20" fill="none" style="margin:0;">
      <path d="M3 5H17L16 16H4L3 5Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="8" cy="17" r="1.2" fill="#fff"/><circle cx="14" cy="17" r="1.2" fill="#fff"/>
    </svg>
    <span id="cartCount">0</span>
  </button>

  <!-- МОДАЛЬНОЕ ОКНО КОРЗИНЫ -->
  <div id="cartModal">
    <div id="cartModalContent">
      <button id="cartModalClose" title="Закрыть">&times;</button>
      <h2 style="margin-top:0;margin-bottom:16px;font-size:1.4em;color:#207ad2;font-weight:800;letter-spacing:0.01em;">
        <svg width="27" height="27" viewBox="0 0 20 20" fill="none" style="vertical-align:-7px;margin-right:6px;">
          <path d="M3 5H17L16 16H4L3 5Z" stroke="#2193b0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8" cy="17" r="1.1" fill="#2bc0e4"/><circle cx="14" cy="17" r="1.1" fill="#2bc0e4"/>
        </svg>
        Ваша корзина
      </h2>
      <ul class="cart-items-list" id="cartItemsList"></ul>
      <div id="cartEmptyMessage" class="cart-empty" style="display:none;">Корзина пуста</div>
      <div class="cartTotal" id="cartTotal" style="display:none;"></div>
      <div class="cart-actions">
        <button class="cartBtn" id="cartContinueBtn">
          <svg width="23" height="23" viewBox="0 0 21 21" fill="none" style="vertical-align:middle;">
            <path d="M12.7 17 L6.5 10.5 L12.7 4" stroke="#35a6ed" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span style="font-weight:800; letter-spacing:0.01em;">Продолжить покупки</span>
        </button>
        <button class="cartBtn" id="cartOrderBtn">Оформить заказ</button>
      </div>
    </div>
  </div>
  <!-- МОДАЛЬНОЕ ОКНО ОФОРМЛЕНИЯ ЗАКАЗА -->
  <div id="orderModal">
    <form id="orderForm">
      <button type="button" id="orderModalClose" title="Закрыть">&times;</button>
      <h3 style="margin-bottom:21px;font-size:1.19em;color:#2193b0;font-weight:800;">Оформление заказа</h3>
      <input type="tel" id="orderPhone" value="+7" maxlength="12" required>
      <div id="phoneHint">Формат: <b>+7XXXXXXXXXX</b></div>
      <input type="text" id="orderAddress" placeholder="Адрес доставки (необязательно)">
      <button type="submit" id="orderSubmitBtn">Подтвердить заказ</button>
      <div id="orderError" style="display:none;"></div>
    </form>
  </div>
  <!-- ЛОГОТИП -->
  <img src="https://web.tk646.ru/wp-content/uploads/2025/06/logotip-sk-2020-scaled.png" alt="Логотип магазина" id="shopLogo" />
  <!-- ГЛАВНАЯ СЕКЦИЯ -->
  <div id="mainSection">
    <h2 id="helloTitle"></h2>
    <button class="orderBtn" id="loggerBtn">Логгер температуры</button>
    <button class="orderBtn" id="recorderBtn">Термописец</button>
    <button class="orderBtn" id="recorderSiBtn">Термописец в Реестре СИ</button>
  </div>
  <!-- КАРТОЧКА -->
  <div id="loggerSection" style="display:none">
    <h2 style="text-align:center;">
      Логгер температуры <br>
      <span style="display:block; font-size:30px; color:#3885da; font-weight:800; margin-top:8px;">Эскорт TH-BLE</span>
    </h2>
    <img src="https://web.tk646.ru/wp-content/uploads/2025/07/th-ble_podklyuchenie_k_datchiku.gif"
         alt="Логгер температуры" class="card-img" />
    <p style="max-width:350px;margin:0 auto 18px;text-align:center;font-weight:800;">
      Умный беспроводной датчик для мониторинга температуры, влажности и магнитного поля.<br>
      Внесён в реестр СИ РФ, BLE дальностью до 200 метров, 3 года автономной работы.<br>
      Устойчив к пыли и влаге (IP54), хранит данные даже без связи.
    </p>
    <button class="orderBtn" id="loggerMoreBtn">Подробнее</button>
    <button class="orderBtn" id="loggerPricesBtn" style="margin-top:12px;">Цены и комплекты</button>
    <button class="backBtn" id="backBtn">
      <svg width="24" height="24" fill="none" stroke="#3885da" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;">
        <polyline points="15 18 9 12 15 6"/>
      </svg>Назад
    </button>
  </div>
  <!-- Подробное описание -->
  <div id="loggerDetailSection" style="display:none">
    <h2>Эскорт TH-BLE — подробное описание</h2>
    <img src="https://web.tk646.ru/wp-content/uploads/2025/07/eskort-th-ble_2234.png" class="card-img" alt="Эскорт TH-BLE" />
    <div class="card-block">
      <ul>
        <li><b>Назначение:</b> мониторинг температуры, влажности, магнитного поля в транспорте, на складах, в медицине и промышленности</li>
        <li><b>Беспроводная связь:</b> Bluetooth Low Energy 4.0/5 Long Range, до 200 м</li>
        <li><b>Автономия:</b> до 3 лет работы от батареи</li>
        <li><b>Память:</b> “черный ящик” — хранение данных при потере связи</li>
        <li><b>Установка:</b> легко крепится без проводов на любую поверхность</li>
        <li><b>Защита:</b> IP54 (пыль, влага, устойчивость к вибрациям)</li>
        <li><b>Настройка:</b> бесплатное мобильное приложение “Конфигуратор датчиков Эскорт” (Android/iOS)</li>
        <li><b>Документы:</b> внесён в Госреестр СИ РФ; поверка — только аккредитованные лаборатории</li>
      </ul>
      <div style="font-size:14px;color:#245;">
        Работает с IoT и M2M платформами, поддержка передачи данных на трекеры, BLE-базы, смартфоны, печать отчетов “на месте”.
      </div>
      <img src="https://web.tk646.ru/wp-content/uploads/2025/07/th-ble_podklyuchenie_k_datchiku.gif"
           alt="Подключение к датчику" style="width:120px;height:auto;display:block;margin:12px auto 4px auto;border-radius:8px;">
    </div>
    <div class="card-block" style="margin-bottom:28px;">
      <b>Технические характеристики:</b>
      <ul>
        <li>Диапазон температуры: -40°С…+50°С, погрешность ±0,5°С</li>
        <li>Влажность: 1–100%, погрешность ±5%</li>
        <li>Габариты: 65×90×40 мм, масса ≤0,4 кг</li>
        <li>Передача данных: Bluetooth BLE 4.0/5 LR</li>
        <li>Класс защиты: IP54</li>
      </ul>
    </div>
    <button class="backBtn" id="loggerDetailBackBtn">
      <svg width="24" height="24" fill="none" stroke="#3885da" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;">
        <polyline points="15 18 9 12 15 6"/>
      </svg>Назад
    </button>
  </div>
  <!-- Комплекты и цены -->
  <div id="loggerPricesSection" style="display:none;flex-direction:column;align-items:center;">
    <h2>Цены и комплекты</h2>
    <div class="card-block" style="margin-bottom:22px;">
      <img src="https://web.tk646.ru/wp-content/uploads/2025/07/eskort-th-ble_2231.png" alt="TH-BLE датчик"
           style="width:105px;height:auto;float:right;margin:0 0 8px 16px;background:transparent;">
      <b>Логгер Эскорт TH-BLE</b><br>
      Беспроводной датчик температуры, влажности, магнитного поля. Bluetooth BLE, мобильное приложение. <b>Без поверки</b>.
      <div style="font-size:18px;color:#248d00;margin:10px 0 6px 0;font-weight:800;"><b>7 500 ₽</b></div>
      <button class="orderBtn loggerCartBtn"
        data-id="thble" data-name="Логгер Эскорт TH-BLE" data-price="7500">
        Добавить в корзину
      </button>
      <div style="clear:both;"></div>
    </div>
    <div class="card-block" style="margin-bottom:22px;">
      <img src="https://web.tk646.ru/wp-content/uploads/2025/06/metrologiya-3.jpg" alt="Поверка"
           style="width:95px;height:auto;float:right;margin:0 0 8px 16px;">
      <b>Метрологическая поверка Эскорт TH-BLE</b><br>
      Поверка в аккредитованной лаборатории, свидетельство о поверке, все документы.
      <div style="font-size:18px;color:#248d00;margin:10px 0 6px 0;font-weight:800;"><b>2 500 ₽</b></div>
      <button class="orderBtn loggerCartBtn"
        data-id="verify" data-name="Метрологическая поверка TH-BLE" data-price="2500">
        Добавить в корзину
      </button>
      <div style="clear:both;"></div>
    </div>
    <div class="card-block" style="margin-bottom:22px;">
      <img src="https://web.tk646.ru/wp-content/uploads/2025/07/eskortrst.jpg" alt="С поверкой"
           style="width:95px;height:auto;float:right;margin:0 0 8px 16px;">
      <b>Логгер Эскорт TH-BLE с поверкой</b><br>
      Датчик с поверкой, внесён в Госреестр СИ РФ. Полный комплект документов.
      <div style="font-size:18px;color:#248d00;margin:10px 0 6px 0;font-weight:800;"><b>10 000 ₽</b></div>
      <button class="orderBtn loggerCartBtn"
        data-id="thble-verif" data-name="Логгер TH-BLE с поверкой" data-price="10000">
        Добавить в корзину
      </button>
      <div style="clear:both;"></div>
    </div>
    <button class="backBtn" id="loggerPricesBackBtn">
      <svg width="24" height="24" fill="none" stroke="#3885da" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;">
        <polyline points="15 18 9 12 15 6"/>
      </svg>Назад
    </button>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Навигация по основным секциям
    function setPage(page) {
      document.body.className = (page === 'main') ? '' : 'inner-page';
      document.getElementById('mainSection').style.display = page === 'main' ? 'flex' : 'none';
      document.getElementById('loggerSection').style.display = page === 'logger' ? 'flex' : 'none';
      document.getElementById('loggerDetailSection').style.display = page === 'detail' ? 'flex' : 'none';
      document.getElementById('loggerPricesSection').style.display = page === 'prices' ? 'flex' : 'none';
    }
    // Корзина
    let cart = [];
    function addToCart(id, name, price) {
      const item = cart.find(x => x.id === id);
      if (item) { item.qty++; }
      else      { cart.push({id, name, price: parseInt(price,10), qty:1});}
      updateCartCount();
    }
    function getCartCount() { return cart.reduce((sum, x) => sum+x.qty, 0);}
    function getCartTotal() { return cart.reduce((sum, x) => sum+x.price*x.qty, 0);}
    function renderCartModal() {
      const list = document.getElementById('cartItemsList');
      const totalDiv = document.getElementById('cartTotal');
      list.innerHTML = '';
      if (cart.length === 0) {
        list.style.display = 'none';
        document.getElementById('cartEmptyMessage').style.display = 'block';
        totalDiv.style.display = 'none';
        return;
      }
      document.getElementById('cartEmptyMessage').style.display = 'none';
      list.style.display = 'block';
      for (let item of cart) {
        const li = document.createElement('li');
        li.className = 'cart-item';
        li.innerHTML = `<span>${item.name}${item.qty>1 ? ' ×'+item.qty : ''}</span>
        <span>${(item.price*item.qty).toLocaleString('ru-RU')} ₽ 
          <button style="background:none;border:none;color:#c22138;font-size:20px;font-weight:700;cursor:pointer;padding:0 0 0 8px;vertical-align:middle;"
                  title="Удалить" onclick="removeCartItem('${item.id}')">&times;</button>
        </span>`;
        list.appendChild(li);
      }
      totalDiv.textContent = 'Итого: ' + getCartTotal().toLocaleString('ru-RU') + ' ₽';
      totalDiv.style.display = 'block';
    }
    function updateCartCount() {
      const cartCountElem = document.getElementById('cartCount');
      let n = getCartCount();
      cartCountElem.textContent = n;
      cartCountElem.style.display = n > 0 ? 'inline-block' : 'none';
    }
    function removeCartItem(id) { cart = cart.filter(x => x.id !== id); updateCartCount(); renderCartModal();}
    function clearCart() { cart = []; updateCartCount();}
    // Обработка +7 в телефоне, не даём стереть
    document.addEventListener('DOMContentLoaded', function() {
      // Приветствие по имени
      let firstName = "Гость";
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
        if (initDataUnsafe && initDataUnsafe.user) {
          firstName = initDataUnsafe.user.first_name || "Гость";
        }
      }
      document.getElementById('helloTitle').innerHTML =
        `👋 Привет, ${firstName}!<br>🌟 Добро пожаловать в наш магазин! 🛒`;
      // Интерфейс разделов
      document.getElementById('loggerBtn').onclick = () => setPage('logger');
      document.getElementById('loggerMoreBtn').onclick = () => setPage('detail');
      document.getElementById('loggerPricesBtn').onclick = () => setPage('prices');
      document.getElementById('backBtn').onclick = () => setPage('main');
      document.getElementById('loggerDetailBackBtn').onclick = () => setPage('logger');
      document.getElementById('loggerPricesBackBtn').onclick = () => setPage('logger');
      document.getElementById('recorderBtn').onclick = () => alert('Раздел "Термописец" появится скоро!');
      document.getElementById('recorderSiBtn').onclick = () => alert('Раздел "Термописец в Реестре СИ" появится скоро!');
      document.querySelectorAll('.loggerCartBtn').forEach(btn => {
        btn.onclick = function() {
          addToCart(
            btn.getAttribute('data-id'),
            btn.getAttribute('data-name'),
            btn.getAttribute('data-price')
          );
          updateCartCount();
          openCartModal();
        };
      });
      document.getElementById('cartButton').onclick = openCartModal;
      document.getElementById('cartModalClose').onclick = closeCartModal;
      document.getElementById('cartContinueBtn').onclick = closeCartModal;
      window.removeCartItem = removeCartItem;
      updateCartCount();
      // --- Телефон: всегда +7, курсор в конец, нельзя стереть
      const phoneInput = document.getElementById('orderPhone');
      phoneInput.addEventListener('input', function() {
        if (!this.value.startsWith('+7')) {
          this.value = '+7';
        }
      });
      phoneInput.addEventListener('focus', function() {
        setTimeout(() => this.setSelectionRange(this.value.length, this.value.length), 0);
      });
    });
    function openCartModal() {
      renderCartModal();
      document.getElementById('cartModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    function closeCartModal() {
      document.getElementById('cartModal').classList.remove('active');
      document.body.style.overflow = '';
    }
    // Оформление заказа: модалка, валидация, отправка в группу
    document.getElementById('cartOrderBtn').onclick = function() {
      if (cart.length === 0) return;
      document.getElementById('orderPhone').value = '+7';
      document.getElementById('orderAddress').value = '';
      document.getElementById('orderError').style.display = 'none';
      document.getElementById('orderModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    };
    document.getElementById('orderModalClose').onclick = closeOrderModal;
    function closeOrderModal() {
      document.getElementById('orderModal').classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // --- ⚠️ НАЧАЛО ОБНОВЛЕННОГО БЛОКА ⚠️ ---
    document.getElementById('orderForm').onsubmit = async function(e) {
      e.preventDefault();
      const phone = document.getElementById('orderPhone').value.trim();
      const address = document.getElementById('orderAddress').value.trim();
      const errorDiv = document.getElementById('orderError');

      if (!/^\+7\d{10}$/.test(phone)) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Введите номер в формате +7XXXXXXXXXX (10 цифр после +7)';
        return;
      }
      errorDiv.style.display = 'none';

      let tgUser = { username: '', first_name: '', last_name: '' };
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        tgUser = Telegram.WebApp.initDataUnsafe.user;
      }

      const userMention = tgUser.username ? `@${tgUser.username}` : '';
      const userName = tgUser.first_name ? tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '') : 'Гость';

      // 1. Формируем список товаров, добавляя стоимость каждой позиции
      let itemsText = cart.map(x =>
        `• ${x.name} ×${x.qty} — <b>${(x.price * x.qty).toLocaleString('ru-RU')} ₽</b>`
      ).join('\n');

      // 2. Получаем общую сумму заказа
      const totalAmount = getCartTotal().toLocaleString('ru-RU');

      // 3. Собираем новое, красивое сообщение с форматированием
      let msg = `<b>🎉 Новый заказ!</b>\n\n` +
                `<b>Клиент:</b> ${userName} ${userMention}\n` +
                `<b>Телефон:</b> <code>${phone}</code>\n` +
                (address ? `<b>Адрес:</b> ${address}\n` : '') +
                `\n<b>Состав заказа:</b>\n${itemsText}\n\n` +
                `<b>Итого: ${totalAmount} ₽</b>`;
      
      try {
        await fetch("https://api.telegram.org/bot8185505891:AAE2uibAdWZ71pBJ5PSiDIAElLuiAjA8P2Y/sendMessage", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            chat_id: -1002513898844,
            text: msg,
            parse_mode: "HTML"
          })
        });
        alert('Спасибо за заказ! Ваши данные отправлены менеджеру в Telegram!');
        clearCart();
        closeCartModal();
        closeOrderModal();
      } catch(err) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Ошибка отправки заказа, попробуйте позже';
        console.error(err); // Выводим ошибку в консоль для отладки
      }
    };
    // --- ⚠️ КОНЕЦ ОБНОВЛЕННОГО БЛОКА ⚠️ ---

  </script>
</body>
</html>
